box: node:7.10-wheezy

build:
  steps:
  - script:
    name: set yarn cache
    code: |
      export YARN_CACHE=$WERCKER_CACHE_DIR/yarn
  - script:
    name: install dependencies
    code: |
      yarn global add bower
      HOME=$YARN_CACHE yarn
  - script:
    name: build files
    code: |
      npm run postinstall
  - script:
    name: copy production files
    code: |
      cp -r dist/* "$WERCKER_OUTPUT_DIR"

deploy:
  box: google/cloud-sdk
  steps:
    - bigtruedata/gcloud-config-set:
      project: dinside-styleguide
    - script:
      name: rsync files
      code: |
        # Authenticate gcloud
        keyfile=$(mktemp)
        echo "$GCS_DS_JSON_KEY_FILE" > "$keyfile"
        gcloud auth activate-service-account \
          --key-file "$keyfile"
        rm "$keyfile"
        # Copy all files
        gsutil -m \
               -h "Cache-Control:max-age=600, must-revalidate, s-maxage=600" \
               -h "X-goog-meta-X-Apps-Cache-Channel: styleguide-dinside" \
               rsync -r \
               -c . \
               $BUCKET

clear-cache:
  box: 
    id: appropriate/curl:latest
    cmd: /bin/sh
  steps:
  - script:
      name: clearing cloudflare cache
      code: |
        # Get urls from cache.txt
        URLS=$(cat $WERCKER_SOURCE_DIR/cache.txt | awk '{printf "\"%s\",", $0}' | sed 's/,$//')
        # DO NOT CHANGE
        [ -z "$CLOUDFLARE_KEY" ] && echo "Need to set CLOUDFLARE_KEY" && exit 1;
        curl -X DELETE "https://api.cloudflare.com/client/v4/zones/$CLOUDFLARE_ZONE/purge_cache" \
        -H "X-Auth-Email: inge.thorud@dagbladet.no" \
        -H "X-Auth-Key: $CLOUDFLARE_AM_KEY" \
        -H "Content-Type: application/json" \
        --data "{\"files\":[$URLS]}"
               
               
               


